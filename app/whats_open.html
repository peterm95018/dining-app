<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta content="utf-8" http-equiv="encoding">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>dining test</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <!-- build:css(.tmp) styles/main.css -->
        <link rel="stylesheet" href="styles/main.css">
        <link rel="stylesheet" href="styles/customMain.css">
        <!-- endbuild -->
		<!--<link rel="stylesheet" href="bower_components/sass-bootstrap/dist/css/bootstrap.min.css">-->
        <!-- build:js scripts/vendor/modernizr.js --> 
        <!-- <script src="bower_components/modernizr/modernizr.js"></script> -->
		<script src="scripts/modernizr.custom.24514.js"></script>
                <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet"> 
        <!-- endbuild -->
    <style type="text/css">
        body {font: 10pt arial;}
    </style>

	<script src="bower_components/momentjs/moment.js"></script>
	<script src="bower_components/jquery/jquery.js"></script>

    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="/scripts/timeline/timeline.js"></script>
    <link rel="stylesheet" type="text/css" href="/scripts/timeline/timeline.css">
    
    
    <style type="text/css">
	div.timeline-event {
        color: white;
        border-radius: 5px;
    }
    div.timeline-event-content {
        padding: 5px;
    }
    div.closed {
        background-color: #F03030; /* red */
        border-color: #bd2828;     /* red */
    }
    div.open {
        background-color: #1AA11A; /* green */
        border-color: #136e13;     /* green */
    }
    div.neither {
		background-color: #add8e6; /* blue */
        border-color: ##97B0F8;     /* blue */
	}
    
    
    </style>

    
    <!--Made Mes's code more scalable-->
    <script type="text/javascript">
		var timeline = null;
		
		var geolocationFlag = false;
	
		
		var myLocation = {};
		function getLocation(){
			if (navigator.geolocation){
				var position = navigator.geolocation.getCurrentPosition(showPosition);
			}
			else{
				console.log("Geolocation is not supported by this browser.");
			}
		}
		function showPosition(position){
			myLocation["latitude"] = position.coords.latitude;
			myLocation["longitude"] = position.coords.longitude;
		}

		//Function which asks for and saves gps coordinates to location
		getLocation();


		var locationSorted = false;
		function updateForLocation(){

			if(myLocation["latitude"] != undefined && myLocation["longitude"] != undefined){
				reSort();
				locationSorted = true;
			}
			else console.log("checked for location.");


			if(!locationSorted) setTimeout(updateForLocation, 3000);
		}

		//Function which loops every 3 seconds until the location is collected, then reSort() is called
		updateForLocation();



		function reSort(){
			//First, clear all of the elements from the timeline
			//Next, call drawVisualization(), and turn on a flag so that it sorts by location
		
			geolocationFlag = true;
			timeline.deleteAllItems(); 
			drawVisualization();

			document.getElementById("changeThis").innerHTML = "Locations closest to you are at the top of the time line";			

		}
		
		
		//Load json with location info
		var masterCalendar;
		$.getJSON("../data/whats-open-hours.json", function (data) {
			masterCalendar = data;
		});
		

			/*
			The MasterCalendar object should be formatted this way
			
			class MasterCalander:
				class DiningHalls:
					class CrownMerrill(Location) //inherits Location
					class CollegeEightOakes(Location)
					...
				class CoffeeCarts:
					class Baskin(Location)
					class EarthMarine(Location)
					...
				class CafesRestaurants:
					class Bananajoes(Location)
					class TerraFresca(Location)
					...
				class FoodTrucks:
					class CruzNGourmet(Location)
					...
			
			//base class for each location, not explicitly defined, the sub-objects
			//in MasterCalendar just take this form
			class Location:
				string name //the name (with spaces and special characters) of the location
				
				class location: //contains the lat, long coordinates of the location, not to be confused with the parent class
					string latitude //is a double, but because of JSON, lat and long is saved as a string
					string longitude
					
				class Monday:
					string open //time the location opens on that day
					string close //time the location closes on that day
				class Tuesday:
					string open
					string close
				class Wednesday:
					string open
					string close
				class Thursday:
					string open
					string close
				class Friday:
					string open
					string close
			
			*/
		

        google.load("visualization", "1");
        
        // Set callback to run when API is loaded
        google.setOnLoadCallback(drawVisualization);
        
        // Called when the Visualization API is loaded.
        function drawVisualization()
		{
			
			//If the calendar hasn't loaded yet, call the func in 100 ms
			if(masterCalendar == undefined){
				window.setTimeout(drawVisualization, 100);
				return;
			}
			
			// Create and populate a data table.
			var data = [];

			// place images here
			var dining_img = '<img src="images/dining.png" style="width:15px; height:15px">';
			var bananaJoes_img = '<img src="images/banana_joes.png" style="width:15px; height:15px">';
			var oakesCafe_img = '<img src="images/oakes_cafe.png" style="width:15px; height:15px">';
			var owlsNest_img = '<img src="images/owls_nest.png" style="width:15px; height:15px">';
			var perkCoffee_img = '<img src="images/perk_coffee_bar.png" style="width:15px; height:15px">';
			
			//Using moment js to get the current date and time
			var now = moment();
			var day_str = now.format("dddd");
			
			
			
			
			
			
			for(var type_name in masterCalendar){   //eg DiningHalls, CoffeeCarts
				var type = masterCalendar[type_name]; //the actual object
				for(var location_name in type){  //loop through locations
					var location = type[location_name]; //the location object
					
					var coords = [location.location.latitude, location.location.longitude];
					
					
					//use the day_str to get the Weekday object
					var hours = location[day_str];
					
					var _now = moment();
					var s, f;
					for(i = 0; i < 7; i++) {
						
						var year = parseInt(_now.format("YYYY"));
						var month = parseInt(_now.format("MM"));
						var day = parseInt(_now.format("DD"));
						
						//If the place isn't open, continue the loop
						if(hours.Open == ""){
							continue;
						}
						
						var open = hours.Open.split(":");
						var close = hours.Close.split(":");
						
						s = new Date(year, month - 1, day, parseInt(open[0]), parseInt(open[1]), 0);
						f = new Date(year, month - 1, day, parseInt(close[0]), parseInt(open[1]), 0);
						
						var content = '';
						
						
						if(type_name == "DiningHalls" ){
							content += dining_img;
						}
						if(type_name == "CoffeeCarts" ){
							content += perkCoffee_img;
						}
						
						if(location_name == "BananaJoes"){
							content += bananaJoes_img;
						}
						if(location_name == "OakesCafe"){
							content += oakesCafe_img;
						}
						if(location_name == "OwlsNestRestaurant"){
							content += owlsNest_img;
						}
						
						content += " " + location.name;

						
						var distance;
						if(geolocationFlag){
							distance = Math.sqrt( (coords[0] - myLocation["latitude"])*(coords[0] - myLocation["latitude"]) + (coords[1] - myLocation["longitude"])*(coords[1] - myLocation["longitude"]));
						} else {
							distance = 0;
						}
						
						var availability = "neither";
						if(i === 0){
							if(new Date() > s && new Date() < f){
								availability = "open";
							}
							else{
								availability = "closed";
							}
							
						}
				
						
						var tmp = {
  							'start': s,
  							'end':   f,  // end is optional
  							'content': content,
  							'distance' : distance,
  							'className': availability,
  							'name': location.name
					 	};
						
						
						
						
						data.push(tmp);
						
						
						
						_now.add("days", 1);
					}
					
					_now = null;


				}
			}
			
			
			// specify options
			var s2 = new Date();
			var f2 = new Date();
			s2.setHours(5);
			s2.setMinutes(0);
			f2.setHours(23);
			f2.setMinutes(59);
            var options = {
                "width":  "100%",
                "height": "100%",//previous value: "300px"
                "style": "box",
				"animateZoom": false,
				zoomable: false,
				height: "auto",
				axisOnTop: true,
				selectable: true, 
				customStackOrder: myStackOrder,
				animate: false,
				groupsOrder: false,
				start: s2,
                end: f2
            };
            

            // Instantiate our timeline object.
            timeline = new links.Timeline(document.getElementById('mytimeline'));
            
            links.events.addListener(timeline, 'select', onSelect);
            
            

            
            
            //reSort data object if geolocated, someone should make this sort happen
            if(geolocationFlag){
				
				var newDataTable = [];
				for(var i = 0; i < data.length; i++){
					var array = [data[i], data[i].distance];
					newDataTable.push(array);
				}
				newDataTable.sort(function(a, b) {return a[1] - b[1]});	
				
				data = [];
				
				for(var i = 0; i < newDataTable.length; i++){
					data.push(newDataTable[i][0]);
					//console.log(newDataTable[i][0].content);
				}
					
			} 

            // Draw our timeline with the created data and options
            timeline.draw(data, options);
			
		}
    
		function onSelect(){
			var sel = timeline.getSelection();
			var item = timeline.getItem(sel[0].row);
			
			

		}
		
		function myStackOrder(item1, item2){
			
		}
    
    
    </script>
          
  
    </head>
    <body>
        <!--[if lt IE 10]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

		<nav class="navbar navbar-fixed-top navbar-inverse" role="navigation">
          <div class="navbar-custom">
            
            <!-- Below is the logo and brand. In order for them to format correctly, they have to remain outside the container div-->
            <a class="navbar-logo pull-left" href="index.html"><img src="images/nav_logo.png"></a> 

          <div class="container">
            <div class="navbar-header"> 
                  <button type="button" class="btn-custom navbar-toggle pull-right" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

                                    
             </div><!-- /.navbar-header -->
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                 <ul class="nav navbar-nav">
                    <li><a href="feedback.html">Feedback</a></li>
                <li><a href="#dininghome">Dining Home</a></li>
                <li><a href="#webportal">Web Portal</a></li>
              </ul>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container -->
          </div><!-- /.navbar-custom -->
       </nav>
		
	    <div class="container">

	      <div class="row">
	        <div class="col-lg-12">
	          <h1 class="page-header">What's Open<small></small></h1>
	        </div>
	      </div>
	      
	      <h3>Time line Info</h3>
	      <p><b>green</b> locations are <b>open</b></p>
	      <p><b>red</b> locations are <b>closed</b></p>
	      <p id="changeThis">Share your location to find the location closest to you</p>

		  <div id="mytimeline"></div>

    <footer>
	   <div class="row">
	      <div class="col-lg-12">
	        <!--<p>&copy; 2014 Regents of the University of California \n About &middot; Feedback &middot; Facebook &middot; Twitter &middot; instagram</p> -->
			<p class="text-centered"><span class="small">&copy; 2014 Regents of the University of California </span>
			&nbsp;
			<a href="https://www.facebook.com/UcscDining"><i class="fa fa-facebook"></i></a>  
			&middot; <a href="https://twitter.com/UCSCDining"><i class="fa fa-twitter"></i></a>
			&middot; <a href="http://instagram.com/ucscdining"><i class="fa fa-instagram"></i> </a>
			</p>
	       </div>
	    </div>
	 </footer>

	      </div> <!-- /.container -->


        <!-- build:js scripts/vendor.js -->
        <!-- bower:js -->
        <script src="bower_components/jquery/jquery.js"></script>
		<script src="bower_components/sass-bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="bower_components/momentjs/moment.js"></script>
        <!-- endbower -->
        <!-- endbuild -->




        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>

        <!-- build:js scripts/main.js -->
        <script data-main="scripts/main" src="bower_components/requirejs/require.js"></script>
        <!-- endbuild -->
		
</body>
</html>
